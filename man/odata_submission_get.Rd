% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/odata_submission_get.R
\name{odata_submission_get}
\alias{odata_submission_get}
\title{Retrieve and rectangle form submissions, parse dates, geopoints, download and
link attachments.}
\usage{
odata_submission_get(
  table = "Submissions",
  skip = NULL,
  top = NULL,
  count = FALSE,
  wkt = FALSE,
  parse = TRUE,
  download = TRUE,
  orders = c("YmdHMS", "YmdHMSz", "Ymd HMS", "Ymd HMSz", "Ymd", "ymd"),
  local_dir = "media",
  pid = get_default_pid(),
  fid = get_default_fid(),
  url = get_default_url(),
  un = get_default_un(),
  pw = get_default_pw(),
  odkc_version = get_default_odkc_version(),
  tz = get_default_tz(),
  verbose = get_ru_verbose()
)
}
\arguments{
\item{table}{The submission EntityType, or in plain words, the table name.
Default: "Submissions" (the main table).
Change to "Submissions.GROUP_NAME" for repeating form groups.
The group name can be found through \code{\link{odata_service_get}}.}

\item{skip}{The number of rows to be omitted from the results.
Example: 10, default: NA (none skipped).}

\item{top}{The number of rows to return.
Example: 100, default: NA (all returned).}

\item{count}{If TRUE, an `@odata.count` property will be returned in the
response from ODK Central. Default: FALSE.}

\item{wkt}{If TRUE, geospatial data will be returned as WKT (Well Known Text)
strings. Default: FALSE, returns GeoJSON structures.
Note that accuracy is only returned through GeoJSON.}

\item{parse}{Whether to parse submission data based on form schema.
Dates and datetimes will be parsed into local time.
Attachments will be downloaded, and the field updated to the local file
path.
Point locations will be split into components; GeoJSON (`wkt=FALSE`) will
be split into latitude, longitude, altitude and accuracy (with anonymous
field names), while WKT will be split into longitude, latitude,and
altitude (missing accuracy) prefixed by the original field name.
Default: TRUE.}

\item{download}{Whether to download attachments to `local_dir` or not.
If in the future, ODK Central supports hot-linking attachments,
this parameter will replace attachment file names with their fully
qualified attachment URL.
Default: TRUE.}

\item{orders}{(vector of character) Orders of datetime elements for
lubridate.
Default:
\code{c("YmdHMS", "YmdHMSz", "Ymd HMS", "Ymd HMSz", "Ymd", "ymd")}.}

\item{local_dir}{The local folder to save the downloaded files to,
default: "media".}

\item{pid}{The numeric ID of the project, e.g.: 2.
Default: \code{\link{get_default_pid}}.
Set default \code{pid} through \code{ru_setup(pid="...")}.
See \code{vignette("Setup", package = "ruODK")}.}

\item{fid}{The alphanumeric form ID, e.g. "build_Spotlighting-0-8_1559885147".
Default: \code{\link{get_default_fid}}.
Set default \code{fid} through \code{ru_setup(fid="...")}.
See \code{vignette("Setup", package = "ruODK")}.}

\item{url}{The ODK Central base URL without trailing slash.
Default: \code{\link{get_default_url}}.
Set default \code{url} through \code{ru_setup(url="...")}.
See \code{vignette("Setup", package = "ruODK")}.}

\item{un}{The ODK Central username (an email address).
Default: \code{\link{get_default_un}}.
Set default \code{un} through \code{ru_setup(un="...")}.
See \code{vignette("Setup", package = "ruODK")}.}

\item{pw}{The ODK Central password.
Default: \code{\link{get_default_pw}}.
Set default \code{pw} through \code{ru_setup(pw="...")}.
See \code{vignette("Setup", package = "ruODK")}.}

\item{odkc_version}{The ODK Central version as decimal number (major.minor).
`ruODK` uses this parameter to adjust for breaking changes in ODK Central.
Default: \code{\link{get_default_odkc_version}} or 0.8 if unset.
Set default \code{get_default_odkc_version} through
\code{ru_setup(odkc_version=0.8)}.
See \code{vignette("Setup", package = "ruODK")}.}

\item{tz}{A timezone to convert dates and times to.
Read `vignette("setup", package = "ruODK")` to learn how `ruODK`'s
timezone can be set globally or per function.}

\item{verbose}{Whether to display debug messages or not.
Read `vignette("setup", package = "ruODK")` to learn how `ruODK`'s
verbosity can be set globally or per function.}
}
\value{
A list of lists.
\itemize{
 \item `value` contains the submissions as list of lists.
 \item `@odata.context` is the URL of the metadata.
 \item `@odata.count` is the total number of rows in the table.
}
}
\description{
\lifecycle{stable}
}
\details{
\code{\link{odata_submission_get}} downloads submissions from
(default) the main form group (submission table) including any non-repeating
form groups, or from any other table as specified by parameter `table`.


With parameter \code{parse=TRUE} (default), submission data is parsed into a
tibble. Any fields of type \code{dateTime} or \code{date} are parsed into
dates, with an optional parameter \code{tz} to specify the local timezone.

A parameter \code{local_dir} (default: \code{media}) specifies a local
directory for downloaded attachment files.
Already existing, previously downloaded attachments will be retained.

With parameter `wkt=TRUE`, spatial fields will be returned as WKT, rather
than GeoJSON. In addition, fields of type `geopoint` will be split into
latitude, longitude, and altitude, prefixed with the original field name.
E.g. a field `start_location` of type `geopoint` will be split into
`start_location_latitude`, `start_location_longitude`, and
`start_location_altitude`. The field name prefix will allow multiple fields
of type `geopoint` to be split into their components without naming
conflicts. Other spatial fields will be retained as WKT.

The only remaining manual step is to optionally join any sub-tables to the
master table.

The parameter `verbose` enables diagnostic messages along the download and
parsing process.

With parameter `parse=FALSE`, submission data is presented as nested list,
which is the R equivalent of the JSON structure returned from the API.
From there, \code{\link{odata_submission_rectangle}} can rectangle the data
into a tibble, and subsequent lines of \code{\link{handle_ru_datetimes}},
\code{\link{handle_ru_attachments}} and \code{\link{handle_ru_geopoints}}
parse dates, download and link file attachments, and split geopoints into
coordinates.
As any of these steps might fail on unexpected errors, `ruODK` offers this
longer, more manual pathway as an option to investigate and narrow down
unexpected or unwanted behaviour.

If the form contains geotraces or geoshapes, the defaults
\code{wkt=FALSE, parse=TRUE} will result in an error when trying to unnest
these arbitrarily long list columns and produce a warning
to run \code{\link{odata_submission_get}} with either \code{wkt=TRUE} or
\code{parse=FALSE}.
}
\examples{
\dontrun{
# Set default credentials, see vignette "setup"
ruODK::ru_setup(
  svc = paste0(
    "https://sandbox.central.getodk.org/v1/projects/14/",
    "forms/build_Flora-Quadrat-0-2_1558575936.svc"
  ),
  un = "me@email.com",
  pw = "..."
)

form_tables <- ruODK::odata_service_get()
data <- odata_submission_get() # default: main data table
data <- odata_submission_get(table = form_tables$url[1]) # same, explicitly
data_sub1 <- odata_submission_get(table = form_tables$url[2]) # sub-table 1
data_sub2 <- odata_submission_get(table = form_tables$url[3]) # sub-table 2

# Skip one row, return the next 1 rows (top), include total row count
data <- odata_submission_get(
  table = form_tables$url[1],
  skip = 1,
  top = 1,
  count = TRUE
)

# Point coordinates (lat, lon, alt, acc) need to be renamed
data <- odata_submission_get(
  table = form_tables$url[1],
  wkt = FALSE
) \%>\%
  dplyr::rename(
    # Adjust coordinate colnames as needed
    # longitude = x13,
    # latitude = x14,
    # altitude = x15,
    # accuracy = x16
  )

# Parse point coordinates into WKT like "POINT (115.8840312 -31.9961844 0)"
data <- odata_submission_get(
  table = form_tables$url[1],
  wkt = TRUE
)
# Columns of type "geopoint" will be split into lat lon alt (no accuracy) and
# prefixed with the ODK geopoint field name. Use parse=FALSE to retain WKT.
# Columns of other spatial types will remain WKT.
}
}
\seealso{
\url{https://odkcentral.docs.apiary.io/#reference/odata-endpoints/odata-form-service}

\url{https://odkcentral.docs.apiary.io/#reference/odata-endpoints/odata-form-service/data-document}

Other odata-api: 
\code{\link{odata_metadata_get}()},
\code{\link{odata_service_get}()}
}
\concept{odata-api}
