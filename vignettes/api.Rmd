---
title: "Accessing the RESTful API"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{restapi}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(ruODK)
```

# Scope
This vignette provides a walk-through of the "getting data out" functions of
the RESTful API endpoints which list and view details.
This is useful to build ETL pipelines from ODK Central into other data warehouses,
or to build automated and reproducible reporting. 

The result will be similar to

* browsing ODK Central and downloading submissions as zip archive,
* viewing ODK Central data in MS PowerBI, MS Excel, or Tableau through the
  OData service, or
* viewing ODK Central data through ruODK's OData functions.

Not implemented (yet) are the "managing ODK Central" functions which create, 
update, and delete projects, forms, users, roles, and permissions. 
We haven't yet found a strong use case to automate those functions - 
ODK Central (driven by humans) does those jobs beautifully.

# Setup ruODK
See [`vignette("Setup", package = "ruODK")`](https://dbca-wa.github.io/ruODK/articles/setup.html) 
for detailed options to configure `ruODK`.

# Projects

List projects.

```{r project_list}
p <- project_list()
p %>% knitr::kable(.)
```

Inspect a project. Turtles are, not surprisingly, number 1. Of course they are.

```{r project_details}
pd <- project_detail(1)
pd %>%dplyr::select(-"verbs") %>%  knitr::kable(.)
```

# Forms
## List forms for a project

```{r form_list}
forms <- form_list(1)
forms  %>% dplyr::select(-"xml") %>% knitr::kable(.)
```

## Show details of one form

```{r form_detail}
form <- form_detail(1, forms$fid[[1]])
form %>% dplyr::select(-"xml") %>% knitr::kable(.)
```

## Inspect form schema

The nested list of lists returned by `form_schema` is the cleanest representation
of the Xform definition available in R.
See the [ODK Central API docs](https://odkcentral.docs.apiary.io/#reference/forms-and-submissions/'-individual-form/retrieving-form-schema-json) and the examples of 
`??ruODK::form_schema` for more detail.

```{r form_schema}
fs <- form_schema(1, forms$fid[[1]])
# listviewer::jsonedit(fs)
```

# Submissions

## List submissions for one form

```{r submission_list}
sl <- submission_list(1, forms$fid[[2]])
sl %>% knitr::kable(.)
```

The list of submissions critically contains each submission's unique ID in
`instance_id`. If the submissions shall be downloaded and uploaded into another
data warehouse, the `instance_id` can be used to determine whether a record
already exists in the downstream warehouse or not.
This workflow is preferable where the majority of submissions is already 
imported into another downstream data warehouse, and we only want to add new 
submissions, as in submissions which are not already imported into the data 
warehouse.

Furthermore, the `instance_id`s can now be used to retrieve the actual 
submissions.

## Get one submission

In order to import each submission, we need to retrieve the data by 
`instance_id`.

```{r submission_detail}
sub <- submission_detail(1, forms$fid[[2]], sl$instance_id[[1]])
sub
```

## Get all submissions for one form
TODO

## Parse submissions
TODO 

# Attachments

## List all attachments for one form
TODO

## Get attachments
TODO
